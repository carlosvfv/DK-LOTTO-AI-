# üöÄ Gu√≠a Completa: Activar Sistema de Cuentas y Pagos

## üìã √çNDICE
1. [Configurar Supabase Auth](#1-configurar-supabase-auth)
2. [Crear Tablas de Base de Datos](#2-crear-tablas)
3. [Instalar Supabase CLI](#3-instalar-supabase-cli)
4. [Deploy Edge Functions](#4-deploy-edge-functions)
5. [Configurar Stripe Webhooks](#5-configurar-stripe)
6. [Poblar Cache de Datos](#6-poblar-cache)
7. [Probar el Sistema](#7-pruebas)

---

## 1Ô∏è‚É£ CONFIGURAR SUPABASE AUTH

### Paso 1.1: Activar Email Provider
```
1. Ve a: https://supabase.com/dashboard/project/dtyckxrqyyvcitmityzv
2. Click en "Authentication" (üîê icono de candado en sidebar izquierdo)
3. Click en "Providers"
4. Busca "Email" ‚Üí Click en el switch para activarlo
5. Configuraci√≥n:
   ‚úÖ Enable Email provider: ON
   ‚úÖ Confirm email: ON (recomendado)
   ‚úÖ Secure email change: ON
6. Click "Save"
```

**‚úÖ Checkpoint:** Deber√≠as ver "Email" con badge verde "Enabled"

---

### Paso 1.2: Activar Google Provider (Opcional pero Recomendado)

#### A. Crear OAuth App en Google Cloud

```
1. Ve a: https://console.cloud.google.com/
2. Crea un proyecto nuevo o selecciona uno existente
3. Ve a "APIs & Services" ‚Üí "Credentials"
4. Click "Create Credentials" ‚Üí "OAuth 2.0 Client ID"
5. Application type: "Web application"
6. Name: "Loteria AI"
7. Authorized redirect URIs:
   https://dtyckxrqyyvcitmityzv.supabase.co/auth/v1/callback
8. Click "Create"
9. COPIA:
   - Client ID: 123456789-xxxxx.apps.googleusercontent.com
   - Client Secret: GOCSPX-xxxxxxxxx
```

#### B. Configurar en Supabase

```
1. Vuelve a Supabase Dashboard ‚Üí Authentication ‚Üí Providers
2. Busca "Google" ‚Üí Click en configurar
3. Pega:
   - Client ID (de Google Cloud)
   - Client Secret (de Google Cloud)
4. Click "Save"
```

**‚úÖ Checkpoint:** Google deber√≠a aparecer con badge verde "Enabled"

---

## 2Ô∏è‚É£ CREAR TABLAS DE BASE DE DATOS

### Paso 2.1: Crear Tabla de Cr√©ditos de Usuario

```
1. Ve a Supabase Dashboard ‚Üí SQL Editor (icono </> en sidebar)
2. Click "New query"
3. Copia TODO el contenido de: CREATE_USER_CREDITS_TABLE.sql
4. Pega en el editor
5. Click "Run" (bot√≥n verde abajo derecha)
6. Deber√≠as ver: "Success. No rows returned"
```

**SQL a ejecutar:**
```sql
-- Table: user_credits
CREATE TABLE IF NOT EXISTS user_credits (
    id UUID PRIMARY KEY DEFAULT auth.uid(),
    email TEXT NOT NULL UNIQUE,
    credits INTEGER DEFAULT 0,
    subscription_type TEXT DEFAULT 'free',
    subscription_expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE user_credits ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own credits" 
    ON user_credits FOR SELECT 
    USING (auth.uid() = id);

CREATE POLICY "Users can update own credits" 
    ON user_credits FOR UPDATE 
    USING (auth.uid() = id);

CREATE POLICY "Service role full access" 
    ON user_credits FOR ALL 
    USING (auth.role() = 'service_role');

-- Trigger para crear cr√©ditos al registrarse
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.user_credits (id, email, credits)
    VALUES (NEW.id, NEW.email, 1);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Update prediction_history
ALTER TABLE prediction_history 
    ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES user_credits(id);

CREATE INDEX IF NOT EXISTS idx_user_credits_email ON user_credits(email);
CREATE INDEX IF NOT EXISTS idx_prediction_history_user ON prediction_history(user_id);
```

---

### Paso 2.2: Crear Tabla de Cache

```
1. Nueva query en SQL Editor
2. Copia TODO el contenido de: CREATE_CACHE_TABLE.sql
3. Click "Run"
```

**SQL a ejecutar:**
```sql
CREATE TABLE IF NOT EXISTS lottery_cache (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    game TEXT NOT NULL UNIQUE,
    data JSONB NOT NULL,
    analysis JSONB NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE lottery_cache ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read cache" ON lottery_cache FOR SELECT USING (true);
CREATE POLICY "Service update cache" ON lottery_cache FOR UPDATE USING (auth.role() = 'service_role');
CREATE POLICY "Service insert cache" ON lottery_cache FOR INSERT WITH CHECK (auth.role() = 'service_role');
```

**‚úÖ Checkpoint:** 
```
Ve a Table Editor ‚Üí Deber√≠as ver:
- user_credits (vac√≠a por ahora)
- lottery_cache (vac√≠a por ahora)
- prediction_history (con nueva columna user_id)
```

---

## 3Ô∏è‚É£ INSTALAR SUPABASE CLI

### Windows (PowerShell como Administrador):

```powershell
# Opci√≥n 1: Con Scoop
scoop install supabase

# Opci√≥n 2: Con npm
npm install -g supabase
```

### Verificar instalaci√≥n:
```powershell
supabase --version
# Debe mostrar: supabase 1.x.x
```

---

## 4Ô∏è‚É£ DEPLOY EDGE FUNCTIONS

### Paso 4.1: Login a Supabase

```bash
supabase login
```
- Se abrir√° navegador
- Autoriza la aplicaci√≥n
- Vuelve a la terminal ‚Üí "Logged in"

---

### Paso 4.2: Link al Proyecto

```bash
cd C:\Users\carlo\.gemini\antigravity\scratch\loteria-dinamarca
supabase link --project-ref dtyckxrqyyvcitmityzv
```

Cuando pregunte:
- Database password: [Entra al dashboard ‚Üí Settings ‚Üí Database ‚Üí busca "Database Password"]

---

### Paso 4.3: Configurar Variables de Entorno (Secrets)

```bash
# DeepSeek API Key
supabase secrets set DEEPSEEK_API_KEY=sk_TU_CLAVE_AQUI

# Stripe Secret Key (Dashboard ‚Üí Developers ‚Üí API Keys ‚Üí Secret key)
supabase secrets set STRIPE_SECRET_KEY=sk_test_XXXXXX

# Stripe Webhook Secret (lo obtendr√°s en paso 5)
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_XXXXX
```

---

### Paso 4.4: Deploy Functions

```bash
# Deploy todas las funciones
supabase functions deploy generate-premium-v2
supabase functions deploy check-license
supabase functions deploy stripe-webhook
```

**Output esperado:**
```
‚úì Deployed generate-premium-v2 (project: dtyckxrqyyvcitmityzv)
  URL: https://dtyckxrqyyvcitmityzv.supabase.co/functions/v1/generate-premium-v2
```

**‚úÖ Checkpoint:** 
```
Dashboard ‚Üí Edge Functions ‚Üí Deber√≠as ver 3 funciones:
- generate-premium-v2 ‚úÖ
- check-license ‚úÖ
- stripe-webhook ‚úÖ
```

---

## 5Ô∏è‚É£ CONFIGURAR STRIPE WEBHOOKS

### Paso 5.1: Crear Webhook Endpoint

```
1. Ve a: https://dashboard.stripe.com/webhooks
2. Click "+ Add endpoint"
3. Endpoint URL: 
   https://dtyckxrqyyvcitmityzv.supabase.co/functions/v1/stripe-webhook
4. Description: "Loteria AI - Payment Handler"
5. Events to send:
   ‚úÖ checkout.session.completed
6. Click "Add endpoint"
```

---

### Paso 5.2: Obtener Webhook Secret

```
1. En la p√°gina del webhook reci√©n creado
2. Click en "Signing secret" ‚Üí "Reveal"
3. Copia el valor: whsec_xxxxxxxxx
4. En terminal:
   supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxx
```

---

### Paso 5.3: Actualizar Links de Pago

**Importante:** Tus links de Stripe deben incluir el email del cliente.

```
1. Ve a: https://dashboard.stripe.com/products
2. Para cada producto (13kr, 49kr, 170kr):
   - Copia el Payment Link
   - Agrega al final: ?prefilled_email={CHECKOUT_EMAIL}
```

Ejemplo:
```
Antes: https://buy.stripe.com/7sYeVd6Cd2D85YNcoLejK0f
Despu√©s: https://buy.stripe.com/7sYeVd6Cd2D85YNcoLejK0f?prefilled_email={CHECKOUT_EMAIL}
```

**‚úÖ Checkpoint:** 
Webhook aparece "Active" en Stripe dashboard

---

## 6Ô∏è‚É£ POBLAR CACHE DE DATOS

### Paso 6.1: Instalar Dependencias

```bash
cd C:\Users\carlo\.gemini\antigravity\scratch\loteria-dinamarca
npm install axios cheerio @supabase/supabase-js
```

---

### Paso 6.2: Configurar Service Key

```
1. Ve a Supabase Dashboard ‚Üí Settings ‚Üí API
2. Copia "service_role" key (secret)
3. Abre: update-cache.mjs
4. L√≠nea 6, reemplaza:
   const SUPABASE_SERVICE_KEY = 'TU_SERVICE_KEY_AQUI';
   
   Por:
   const SUPABASE_SERVICE_KEY = 'eyJhbGc...tu_key_completa';
```

---

### Paso 6.3: Ejecutar Script de Poblaci√≥n

```bash
node update-cache.mjs
```

**Output esperado:**
```
üé∞ Processing LOTTO...
üì• Scraping lotto data from LotteryGuru...
‚úÖ Scraped 100 draws for lotto
‚úÖ lotto cache updated successfully!

üé∞ Processing VIKINGLOTTO...
...
üéâ Cache update completed!
```

**‚úÖ Checkpoint:** 
```
Dashboard ‚Üí Table Editor ‚Üí lottery_cache
Deber√≠as ver 3 filas:
- lotto (data: 100 arrays, analysis: JSON)
- vikinglotto
- eurojackpot
```

---

## 7Ô∏è‚É£ PRUEBAS DEL SISTEMA

### Prueba 1: Registro de Usuario

```
1. Abre: index.html en navegador
2. Click "AI Premium"
3. Deber√≠a aparecer modal de login
4. Completa email + contrase√±a
5. Click "Registrarse"
6. Revisa inbox ‚Üí confirma email
7. Login ‚Üí Deber√≠as ver: "Usuario | üíé 1" arriba derecha
```

---

### Prueba 2: Uso de Cr√©dito Gratis

```
1. Con sesi√≥n iniciada
2. Click "AI Premium"
3. Espera 25-35 segundos
4. Deber√≠as ver n√∫meros generados
5. Contador actualiza: "Usuario | üíé 0"
```

---

### Prueba 3: Compra de Cr√©ditos (Modo TEST)

```
1. Con 0 cr√©ditos, click "AI Premium"
2. Modal de pago aparece
3. Click "PREMIUM X5 - 49 kr"
4. En Stripe usa tarjeta de prueba:
   - N√∫mero: 4242 4242 4242 4242
   - Fecha: 12/34
   - CVC: 123
5. Completa pago
6. Webhook procesa (10 segundos aprox)
7. Recarga p√°gina
8. Contador: "Usuario | üíé 5"
```

---

### Prueba 4: Multiidioma

```
1. Click üá©üá∞ DA
2. Modal debe estar en dan√©s
3. Click üá¨üáß EN
4. Modal debe cambiar a ingl√©s
```

---

## üéâ ¬°SISTEMA COMPLETO ACTIVADO!

### üìä Checklist Final:

- ‚úÖ Autenticaci√≥n Email/Google funcionando
- ‚úÖ Usuarios reciben 1 cr√©dito gratis al registrarse
- ‚úÖ Contador de cr√©ditos visible
- ‚úÖ Pagos de Stripe a√±aden cr√©ditos autom√°ticamente
- ‚úÖ AI Premium descuenta cr√©ditos correctamente
- ‚úÖ Sistema multiidioma (DA/EN) funciona
- ‚úÖ Cache de datos actualizado

---

## üîÑ MANTENIMIENTO

### Actualizar Cache (Cada semana):

```bash
node update-cache.mjs
```

O automatizar con Windows Task Scheduler:
```bash
schtasks /create /tn "UpdateLotteryCache" /tr "node C:\...\update-cache.mjs" /sc WEEKLY /d MON /st 02:00
```

---

## üÜò TROUBLESHOOTING

### Problema: "No session found"
**Soluci√≥n:** Usuario no est√° logueado. Verifica que Supabase Auth est√° activado.

### Problema: "No credits remaining"
**Soluci√≥n:** Verifica que:
1. Tabla user_credits existe
2. Trigger handle_new_user se ejecut√≥
3. Webhook de Stripe est√° activo

### Problema: Webhook no funciona
**Soluci√≥n:**
1. Verifica URL: https://dtyckxrqyyvcitmityzv.supabase.co/functions/v1/stripe-webhook
2. Verifica STRIPE_WEBHOOK_SECRET est√° configurado
3. Ve a Stripe Dashboard ‚Üí Webhooks ‚Üí Click en endpoint ‚Üí "Attempts" para ver errores

---

## üìû SOPORTE

Si algo no funciona:
1. Revisa logs en Supabase: Dashboard ‚Üí Edge Functions ‚Üí Logs
2. Revisa Stripe logs: Dashboard ‚Üí Webhooks ‚Üí Attempts
3. Abre consola del navegador (F12) para errores de frontend

---

**üöÄ ¬°Todo listo para vender!**
